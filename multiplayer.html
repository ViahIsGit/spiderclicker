<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Spider Clicker - Multiplayer</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Comic+Neue:wght@400;700&display=swap" rel="stylesheet" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Happy+Monkey&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <style>
  *{
    font-family: "Happy Monkey", cursive;
  }
    body {
        font-family: "Happy Monkey", cursive;
        margin: 0;
        padding: 0;
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
        user-select: none;
        overflow: hidden;
        background: #000;
        background-image: 
          linear-gradient(45deg, #222 25%, transparent 25%, transparent 75%, #222 75%, #222),
          linear-gradient(45deg, #222 25%, transparent 25%, transparent 75%, #222 75%, #222);
        background-size: 40px 40px;
        background-position: 0 0, 20px 20px;
        color: #fff;
      }
      .container {
        position: relative;
        width: 100%;
        height: 100%;
        display: flex;
        user-select: none;
        flex-direction: column;
        align-items: center;
        justify-content: center;
      }
      .button {
        width: 48px;
        height: 48px;
        font-size: 20px;
        background-color: #222;
        border: 2px solid #555;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #fff;
      }
      .right-panel {
        position: absolute;
        top: 16px;
        right: 16px;
        width: 256px;
        background-color: #222;
        border: 2px solid #555;
        border-radius: 8px;
        padding: 8px;
        overflow-y: auto;
      }
      .right-panel::-webkit-scrollbar {
        width: 8px;
      }
      .right-panel::-webkit-scrollbar-thumb {
        background-color: #888;
        border-radius: 4px;
        transition: background-color 0.3s ease;
      }
      .right-panel::-webkit-scrollbar-thumb:hover {
        background-color: #555;
      }
      .right-panel::-webkit-scrollbar-track {
        background-color: #333;
        border-radius: 4px;
      }
      .item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px;
        border: 2px solid #555;
        border-radius: 8px;
        margin-bottom: 8px;
        background-color: #333;
      }
      .center-info {
        position: absolute;
        font-family: 'Comic Neue', cursive;
        top: 16px;
        left: 50%;
        transform: translateX(-50%);
        text-align: center;
      }
      .center-info .info {
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .center-info .info .text {
        font-size: 24px;
        font-weight: bold;
      }
      .center-info .details {
        font-size: 18px;
      }
      .main-spider {
        position: relative;
      }
      .main-spider img {
        width: 128px;
        height: 128px;
      }
      .player-info {
        margin-bottom: 16px;
      }
      .player-info h3 {
        margin: 0;
        font-size: 18px;
        color: #4d4d4d;
      }
      .top-left-buttons {
        position: absolute;
        top: 16px;
        left: 16px;
        display: flex;
        gap: 8px;
      }
      /* Modal base */
.modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
  background-color: #1e1e1e;
  border: none;
  z-index: 10000;
  display: flex;
  flex-direction: column;
}

/* Cabeçalho */
.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 16px;
  background-color: #2c2c2c;
  border-bottom: 1px solid #444;
}

.modal-header h2 {
  margin: 0;
  font-size: 18px;
  color: #f1f1f1;
}

.modal-header .close {
  cursor: pointer;
  font-size: 28px;
  color: #fff;
}

/* Conteúdo do chat */
.modal-body {
  flex: 1;
  padding: 16px;
  overflow-y: auto;
  background-color: #1e1e1e;
  color: #eee;
  font-size: 14px;
}

.modal-footer {
  display: flex;
  position: absolute;
  bottom: 0;
  left: 0;
  right: 0;
  padding: 12px 16px;
  background-color: #2c2c2c;
  border-top: 1px solid #444;
}

.modal-footer input {
  flex: 1;
  padding: 10px;
  border: 1px solid #444;
  border-radius: 6px;
  background-color: #333;
  color: #fff;
  margin-right: 8px;
}

.modal-footer button {
  padding: 10px 16px;
  border: none;
  border-radius: 6px;
  background-color: #4a90e2;
  color: white;
  font-weight: bold;
  cursor: pointer;
  transition: background-color 0.3s ease;
}

.modal-footer button:hover {
  background-color: #357abd;
}


    .overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 9999;
    }

    .voice-controls {
      position: fixed;
      bottom: 20px;
      right: 20px;
      display: flex;
      gap: 10px;
      background: rgba(0, 0, 0, 0.8);
      padding: 10px;
      border-radius: 10px;
      z-index: 1000;
    }

    .voice-button {
      background: #444;
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      transition: background 0.3s;
    }

    .voice-button:hover {
      background: #555;
    }

    .voice-button.muted {
      background: #f44336;
    }

    .volume-control {
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .volume-slider {
      width: 100px;
      height: 4px;
      -webkit-appearance: none;
      background: #444;
      border-radius: 2px;
      outline: none;
    }

    .volume-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 12px;
      height: 12px;
      background: white;
      border-radius: 50%;
      cursor: pointer;
    }

    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 10px 20px;
      border-radius: 5px;
      color: white;
      z-index: 1000;
      animation: fadeIn 0.3s, fadeOut 0.3s 2.7s;
    }

    .notification.success {
      background: #4caf50;
    }

    .notification.error {
      background: #f44336;
    }

    .notification.info {
      background: #2196f3;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes fadeOut {
      from { opacity: 1; transform: translateY(0); }
      to { opacity: 0; transform: translateY(-20px); }
    }

    @media (max-width: 768px) {
      .right-panel {
        position: fixed;
        bottom: 80px;
        left: 0;
        right: 0;
        top: auto;
        width: 100%;
        max-height: 30vh;
        border-radius: 16px 16px 0 0;
        z-index: 100;
      }

      .voice-controls {
        bottom: 70px;
      }
    }
    
@media (max-width: 768px) {
  .right-panel {
    display: none;              /* escondido por padrão */
    position: fixed;
    top: 0;
    left: 0;                    /* ocupa a tela toda */
    width: 100vw;
    height: 100vh;
    background: #1e1e1e;
    box-shadow: none;
    border: none;
    overflow-y: auto;
    z-index: 10000;
    border-radius: 0;
  }

  .right-panel.open {
    display: block;             /* aparece como modal fullscreen */
  }

  .overlay {
    display: none;              /* opcional no fullscreen */
  }
}
  </style>
</head>
<body>
  <div class="container">
    <div class="top-left-buttons">
      <button class="button" id="leaveRoomButton" style="display: none;" onclick="leaveRoom()">
        <i class="fas fa-sign-out-alt"></i>
      </button>
      <button class="button" id="chatButton" onclick="openChatModal()">
        <i class="fas fa-comments"></i>
      </button>
       <button class="button" id="toggle-panel">
        <i class="fas fa-bars"></i>
      </button>
    </div>
    <div class="right-panel">
      <div class="player-info">
        <h3>Seus Dados:</h3>
        <div id="currentPlayerInfo">Carregando...</div>
      </div>
      <div class="player-info">
        <h3>Outros Jogadores:</h3>
        <div id="otherPlayersInfo">Carregando...</div>
      </div>
    </div>
    <div class="center-info">
      <div class="info">
        <div class="text" id="currencyDisplay">Teias: 0</div>
      </div>
      <div class="details" id="bonusDisplay">x1 Bonus</div>
      <div class="details" id="autoClickerDisplay">0 AutoClicker</div>
    </div>
    <div class="main-spider" onclick="increaseCurrency()">
      <img alt="Large spider" src="imgs/Clicker.png" />
    </div>
  </div>

  <!-- Modal do Chat -->
  <div class="overlay" id="chatOverlay"></div>
  <div class="modal" id="chatModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Chat da Sala</h2>
        <span class="close" onclick="closeChatModal()">&times;</span>
      </div>
      <div class="modal-body" id="chatMessages">
        <!-- Mensagens do chat serão exibidas aqui -->
      </div>
      <div class="modal-footer">
        <input type="text" id="chatInput" placeholder="Digite sua mensagem..." />
        <button onclick="sendMessage()">Enviar</button>
      </div>
    </div>
  </div>

  <div class="voice-controls">
    <button class="voice-button" id="muteButton" onclick="toggleMute()">
      <i class="material-icons">mic</i>
    </button>
    <button class="voice-button" id="deafenButton" onclick="toggleDeafen()">
      <i class="material-icons">headset</i>
    </button>
    <div class="volume-control">
      <i class="material-icons">volume_up</i>
      <input type="range" class="volume-slider" id="volumeSlider" min="0" max="100" value="100">
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
<script>
  // Configuração do Firebase
  const firebaseConfig = {
  apiKey: "AIzaSyCei0u5MbmiSUYeMM52DVKIiPIheq1IMLo",
  authDomain: "spiderclicker06.firebaseapp.com",
  projectId: "spiderclicker06",
  storageBucket: "spiderclicker06.firebasestorage.app",
  messagingSenderId: "81956560892",
  appId: "1:81956560892:web:169cbdb87a13626c975c79",
  measurementId: "G-P3CG6Z9CC0"
};

  // Inicialize o Firebase
  const app = firebase.initializeApp(firebaseConfig);
  const database = firebase.database();
  closeChatModal();

  let currency = 0;
  let clickMultiplier = 1;
  let roomName = '';
  let playerName = '';
  
  // Estado do chat de voz
  let localStream = null;
  let isMuted = false;
  let isDeafened = false;
  let peerConnections = {};
  let audioContext = null;
  let volumeNode = null;

  // -----------------------------
  // Chat de Texto
  // -----------------------------

  function openChatModal() {
    document.getElementById('chatModal').style.display = 'block';
    document.getElementById('chatOverlay').style.display = 'block';
  }

  function closeChatModal() {
    document.getElementById('chatModal').style.display = 'none';
    document.getElementById('chatOverlay').style.display = 'none';
  }

  function sendMessage() {
    const message = document.getElementById('chatInput').value;
    if (message.trim() !== '') {
      const chatRef = database.ref(`multiplayer/rooms/${roomName}/chat`);
      chatRef.push({
        sender: playerName,
        message: message,
        timestamp: firebase.database.ServerValue.TIMESTAMP
      });
      document.getElementById('chatInput').value = '';
    }
  }

  function displayChatMessages(messages) {
    const chatMessages = document.getElementById('chatMessages');
    chatMessages.innerHTML = '';
    messages.forEach(message => {
      const messageElement = document.createElement('div');
      messageElement.textContent = `${message.sender}: ${message.message}`;
      chatMessages.appendChild(messageElement);
    });
  }

  function listenToChat() {
    const chatRef = database.ref(`multiplayer/rooms/${roomName}/chat`);
    chatRef.on('value', (snapshot) => {
      const messages = [];
      snapshot.forEach(childSnapshot => {
        messages.push(childSnapshot.val());
      });
      displayChatMessages(messages);
    });
  }

  // -----------------------------
  // Gerenciamento de Salas
  // -----------------------------

  function showRoomChoiceAlert() {
    const choice = confirm("Deseja criar uma nova sala ou entrar em uma sala existente?\n\nClique em 'OK' para criar ou em 'Cancelar' para entrar.");
    if (choice) {
      createRoom();
    } else {
      joinRoomPrompt();
    }
  }

  function checkRoomExists(roomName) {
    const roomRef = database.ref(`multiplayer/rooms/${roomName}`);
    return roomRef.once('value').then(snapshot => snapshot.exists());
  }

  function createRoom() {
    roomName = prompt("Digite o nome da sala:");
    if (roomName) {
      checkRoomExists(roomName).then(exists => {
        if (exists) {
          alert("Essa sala já existe. Escolha outro nome.");
          createRoom();
        } else {
          const roomRef = database.ref(`multiplayer/rooms/${roomName}`);
          roomRef.set({ players: {}, chat: {} }).then(() => {
            joinRoom(roomName);
          });
        }
      });
    }
  }

  function joinRoomPrompt() {
    roomName = prompt("Digite o nome da sala:");
    if (roomName) {
      checkRoomExists(roomName).then(exists => {
        if (exists) {
          joinRoom(roomName);
        } else {
          alert("Sala não encontrada. Verifique o nome.");
          joinRoomPrompt();
        }
      });
    }
  }

  // -----------------------------
  // Chat de Voz - Controles
  // -----------------------------

  function updateVoiceButtonStates() {
    const muteButton = document.getElementById('muteButton');
    const deafenButton = document.getElementById('deafenButton');
    const micIcon = muteButton.querySelector('i');
    const headsetIcon = deafenButton.querySelector('i');

    micIcon.textContent = isMuted ? 'mic_off' : 'mic';
    headsetIcon.textContent = isDeafened ? 'headset_off' : 'headset';

    muteButton.classList.toggle('muted', isMuted);
    deafenButton.classList.toggle('muted', isDeafened);
  }

  function toggleMute() {
    if (!localStream) return;
    isMuted = !isMuted;
    localStream.getAudioTracks().forEach(track => track.enabled = !isMuted);
    updateVoiceButtonStates();
    showNotification(isMuted ? 'Microfone desativado' : 'Microfone ativado', 'info');

    if (roomName && playerName) {
      database.ref(`multiplayer/rooms/${roomName}/players/${playerName}`).update({ isMuted });
    }
  }

  function toggleDeafen() {
    isDeafened = !isDeafened;
    Object.values(peerConnections).forEach(pc => {
      const audioElement = document.querySelector(`[data-peer-id="${pc.peerId}"]`);
      if (audioElement) audioElement.muted = isDeafened;
    });
    updateVoiceButtonStates();
    showNotification(isDeafened ? 'Áudio desativado' : 'Áudio ativado', 'info');

    if (roomName && playerName) {
      database.ref(`multiplayer/rooms/${roomName}/players/${playerName}`).update({ isDeafened });
    }
  }

  async function initVoiceChat() {
    try {
      if (!await initAudioContext()) throw new Error('Falha no contexto de áudio');

      localStream = await navigator.mediaDevices.getUserMedia({
        audio: { echoCancellation: true, noiseSuppression: true, autoGainControl: true }
      });

      await setupAudioStream(localStream);
      if (isMuted) localStream.getAudioTracks().forEach(track => track.enabled = false);

      updateVoiceButtonStates();
      showNotification('Chat de voz iniciado!', 'success');

      if (roomName && playerName) {
        database.ref(`multiplayer/rooms/${roomName}/players/${playerName}`).update({
          isMuted, isDeafened, hasAudio: true
        });
      }
    } catch (err) {
      console.error(err);
      showNotification('Erro ao acessar microfone', 'error');
      if (roomName && playerName) {
        database.ref(`multiplayer/rooms/${roomName}/players/${playerName}`).update({ hasAudio: false });
      }
    }
  }

  async function createPeerConnection(remotePlayerName) {
    if (peerConnections[remotePlayerName]) return;

    const pc = new RTCPeerConnection({
      iceServers: [
        { urls: 'stun:stun.l.google.com:19302' },
        { urls: 'stun:stun1.l.google.com:19302' }
      ]
    });

    pc.peerId = remotePlayerName;
    peerConnections[remotePlayerName] = pc;

    if (localStream) {
      localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
    }

    const audioElem = document.createElement('audio');
    audioElem.autoplay = true;
    audioElem.dataset.peerId = remotePlayerName;
    audioElem.volume = document.getElementById('volumeSlider').value / 100;
    audioElem.muted = isDeafened;
    document.body.appendChild(audioElem);

    pc.ontrack = (event) => {
      audioElem.srcObject = event.streams[0];
    };

    pc.onicecandidate = (event) => {
      if (event.candidate) {
        database.ref(`multiplayer/rooms/${roomName}/candidates/${playerName}_${remotePlayerName}`).push({
          candidate: event.candidate.toJSON()
        });
      }
    };

    pc.onconnectionstatechange = () => {
      if (['disconnected', 'failed'].includes(pc.connectionState)) {
        closePeerConnection(remotePlayerName);
      }
    };

    return pc;
  }

  function closePeerConnection(remotePlayerName) {
    const pc = peerConnections[remotePlayerName];
    if (pc) {
      const audioElem = document.querySelector(`[data-peer-id="${remotePlayerName}"]`);
      if (audioElem) audioElem.remove();
      pc.close();
      delete peerConnections[remotePlayerName];
    }
  }

  // -----------------------------
  // Funções Auxiliares
  // -----------------------------

  function showNotification(message, type = 'info') {
    const n = document.createElement('div');
    n.className = `notification ${type}`;
    n.textContent = message;
    document.body.appendChild(n);
    setTimeout(() => n.remove(), 3000);
  }

  async function initAudioContext() {
    try {
      audioContext = new (window.AudioContext || window.webkitAudioContext)();
      volumeNode = audioContext.createGain();
      volumeNode.connect(audioContext.destination);
      return true;
    } catch {
      return false;
    }
  }

  async function setupAudioStream(stream) {
    if (!audioContext) await initAudioContext();
    const source = audioContext.createMediaStreamSource(stream);
    source.connect(volumeNode);
  }

  function updateVolume(value) {
    if (volumeNode) volumeNode.gain.value = value / 100;
    Object.values(peerConnections).forEach(pc => {
      const audioElement = document.querySelector(`[data-peer-id="${pc.peerId}"]`);
      if (audioElement) audioElement.volume = value / 100;
    });
  }

  document.getElementById('volumeSlider').addEventListener('input', (e) => {
    updateVolume(e.target.value);
  });

  // -----------------------------
  // Lógica de Jogador
  // -----------------------------

  function updatePlayersUI(players) {
    const currentPlayerInfo = document.getElementById('currentPlayerInfo');
    const otherPlayersInfo = document.getElementById('otherPlayersInfo');
    currentPlayerInfo.innerHTML = '';
    otherPlayersInfo.innerHTML = '';

    for (const playerKey in players) {
      const player = players[playerKey];
      const el = document.createElement('div');
      el.className = 'player-item';
      el.innerHTML = `
        <div class="player-avatar">${player.name[0].toUpperCase()}</div>
        <div class="player-info">
          <div>${player.name}</div>
          <div>${player.currency} Teias (x${player.clickMultiplier})</div>
        </div>
        <div class="player-controls">
          ${player.isMuted ? '<i class="material-icons">mic_off</i>' : ''}
        </div>
      `;
      if (playerKey === playerName) currentPlayerInfo.appendChild(el);
      else otherPlayersInfo.appendChild(el);
    }
  }

  async function handleNewPlayer(remotePlayerName) {
    if (remotePlayerName === playerName) return;
    try {
      const pc = await createPeerConnection(remotePlayerName);
      if (!pc) return;
      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);
      await database.ref(`multiplayer/rooms/${roomName}/offers/${playerName}_${remotePlayerName}`).set({
        type: offer.type, sdp: offer.sdp
      });
    } catch (err) {
      showNotification(`Erro ao conectar com ${remotePlayerName}`, 'error');
    }
  }

  function joinRoom(roomName) {
    playerName = prompt("Digite seu nome:");
    if (!playerName) return;

    initVoiceChat().then(() => {
      const playerRef = database.ref(`multiplayer/rooms/${roomName}/players/${playerName}`);
      playerRef.set({ name: playerName, currency, clickMultiplier, isMuted: false });
      playerRef.onDisconnect().remove();

      const roomRef = database.ref(`multiplayer/rooms/${roomName}/players`);
      roomRef.on('value', (snapshot) => {
        const players = snapshot.val();
        if (players) {
          updatePlayersUI(players);
          Object.keys(players).forEach(k => { if (k !== playerName) handleNewPlayer(k); });
        }
      });

      document.getElementById('leaveRoomButton').style.display = 'block';
      listenToChat();

      // Ofertas
      database.ref(`multiplayer/rooms/${roomName}/offers`).on('child_added', async (snap) => {
        const [sender, receiver] = snap.key.split('_');
        if (receiver === playerName) {
          const pc = await createPeerConnection(sender);
          const offer = snap.val();
          await pc.setRemoteDescription(new RTCSessionDescription(offer));
          const answer = await pc.createAnswer();
          await pc.setLocalDescription(answer);
          database.ref(`multiplayer/rooms/${roomName}/answers/${receiver}_${sender}`).set(answer);
        }
      });

      // Respostas
      database.ref(`multiplayer/rooms/${roomName}/answers`).on('child_added', async (snap) => {
        const [sender, receiver] = snap.key.split('_');
        if (receiver === playerName) {
          const pc = peerConnections[sender];
          if (pc) await pc.setRemoteDescription(new RTCSessionDescription(snap.val()));
        }
      });

      // ICE
      database.ref(`multiplayer/rooms/${roomName}/candidates`).on('child_added', async (snap) => {
        const [sender, receiver] = snap.key.split('_');
        if (receiver === playerName) {
          const pc = peerConnections[sender];
          if (pc) {
            const candidates = snap.val();
            for (const k in candidates) {
              await pc.addIceCandidate(new RTCIceCandidate(candidates[k].candidate));
            }
          }
        }
      });
    });
  }

  function leaveRoom() {
    Object.keys(peerConnections).forEach(closePeerConnection);
    if (localStream) { localStream.getTracks().forEach(t => t.stop()); localStream = null; }
    if (volumeNode) { volumeNode.disconnect(); volumeNode = null; }
    if (audioContext) { audioContext.close(); audioContext = null; }

    const playerRef = database.ref(`multiplayer/rooms/${roomName}/players/${playerName}`);
    playerRef.remove().then(() => location.reload());
  }

  function increaseCurrency() {
    currency += clickMultiplier;
    updateDisplays();
    if (roomName && playerName) {
      database.ref(`multiplayer/rooms/${roomName}/players/${playerName}`).update({ currency });
    }
  }

  function updateDisplays() {
    document.getElementById('currencyDisplay').textContent = `Teias: ${currency}`;
    document.getElementById('bonusDisplay').textContent = `x${clickMultiplier} Bonus`;
  }

  window.onload = () => { showRoomChoiceAlert(); closeChatModal(); };
</script>
<script>
  document.addEventListener("DOMContentLoaded", () => {
    const rightPanel = document.querySelector(".right-panel");
    const toggleBtn = document.querySelector("#toggle-panel");

    // Clique no botão para abrir/fechar
    toggleBtn.addEventListener("click", () => {
      rightPanel.classList.toggle("open");
    });

    // Fechar painel clicando fora (overlay opcional)
    const overlay = document.querySelector(".overlay");
    if (overlay) {
      overlay.addEventListener("click", () => {
        rightPanel.classList.remove("open");
        overlay.style.display = "none";
      });

      toggleBtn.addEventListener("click", () => {
        if (rightPanel.classList.contains("open")) {
          overlay.style.display = "block";
        } else {
          overlay.style.display = "none";
        }
      });
    }
  });
</script>
</body>
</html>